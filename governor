#!/usr/bin/env bash
GOVERNOR="performance"
FIND=`command -v governor`
DIR="/usr/local/bin/"
if [ $# -eq 0 ]; then
	echo "Missing options!";
	echo "(run $0 -h for help)";
	echo "";
	exit 0;
fi

while getopts "copsrumh" OPTION; do
	case $OPTION in

	c)
		sudo sed -i "2s/.*/GOVERNOR="'"conservative"'"/" $FIND
		governor -r
		;;
	o)
		sudo sed -i "2s/.*/GOVERNOR="'"ondemand"'"/" $FIND
		governor -r
		;;
	p)
		sudo sed -i "2s/.*/GOVERNOR="'"performance"'"/" $FIND
		governor -r
		;;
	s)
		sudo sed -i "2s/.*/GOVERNOR="'"schedutil"'"/" $FIND
		governor -r
		;;
	r)
		echo "$GOVERNOR" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
		;;
	u)
		sudo mv -f $FIND $FIND.orig
		sudo wget -cq https://raw.githubusercontent.com/pyavitz/scripts/master/governor -P $DIR
		sudo chmod +x $FIND
		if [ -f $FIND ]; then
			sudo rm -f $FIND.orig;
		else
			sudo mv -f $FIND.orig $FIND;
		fi
		governor -h
		;;
	m)
		while [ 1 ]
		do
		CHOICE=$(
		whiptail --backtitle "Debian Image Builder" --title "Governor" --menu "" --nocancel --ok-button "Select" 0 0 0 \
			"1)" "Conservative"   \
			"2)" "Ondemand"  \
			"3)" "Performance" \
			"4)" "Schedutil" \
			"5)" "Exit ..."  3>&2 2>&1 1>&3	
		)
		case $CHOICE in
			"1)")
				governor -c
				sleep 1s
				whiptail --msgbox "Governor set to Conservative" 0 0
				;;
			"2)")
				governor -o
				sleep 1s
				whiptail --msgbox "Governor set to Ondemand" 0 0
				;;
			"3)")
		        	governor -p
				sleep 1s
				whiptail --msgbox "Governor set to Performance" 0 0
				;;
			"4)")
				governor -s
				sleep 1s
				whiptail --msgbox "Governor set to Schedutil" 0 0
				;;
			"5)")
				clear -x
				exit 0
				;;
		esac
		done
		;;
	h)
		echo -e "\e[1;37mCPU frequency scaling\e[0m"
		echo "Usage: "
		echo ""
		echo "   -c       Conservative"
		echo "   -o       Ondemand"
		echo "   -p       Performance"
		echo "   -s       Schedutil"
		echo ""
		echo "   -r       Run"
		echo "   -u       Update"
		echo ""
		exit 0
		;;
	esac
done
